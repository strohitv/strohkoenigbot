{
  "databaseChangeLog": [
    {
      "changeSet": {
        "id": "1",
        "author": "strohkoenig",
        "changes": [
          {
            "createTable": {
              "tableName": "configuration",
              "columns": [
                {
                  "column": {
                    "name": "id",
                    "type": "bigint",
                    "autoIncrement": true,
                    "constraints": {
                      "primaryKey": true,
                      "nullable": false
                    }
                  }
                },
                {
                  "column": {
                    "name": "config_name",
                    "type": "varchar(50)"
                  }
                },
                {
                  "column": {
                    "name": "config_value",
                    "type": "varchar(5000)"
                  }
                }
              ]
            }
          },
          {
            "createTable": {
              "tableName": "splatoon_login",
              "columns": [
                {
                  "column": {
                    "name": "id",
                    "type": "bigint",
                    "autoIncrement": true,
                    "constraints": {
                      "primaryKey": true,
                      "nullable": false
                    }
                  }
                },
                {
                  "column": {
                    "name": "nickname",
                    "type": "varchar(50)"
                  }
                },
                {
                  "column": {
                    "name": "cookie",
                    "type": "varchar(500)"
                  }
                },
                {
                  "column": {
                    "name": "expires_at",
                    "type": "timestamp"
                  }
                },
                {
                  "column": {
                    "name": "session_token",
                    "type": "varchar(500)"
                  }
                }
              ]
            }
          },
          {
            "createTable": {
              "tableName": "twitch_auth",
              "columns": [
                {
                  "column": {
                    "name": "id",
                    "type": "bigint",
                    "autoIncrement": true,
                    "constraints": {
                      "primaryKey": true,
                      "nullable": false
                    }
                  }
                },
                {
                  "column": {
                    "name": "token",
                    "type": "varchar(40)"
                  }
                },
                {
                  "column": {
                    "name": "channel_id",
                    "type": "varchar(30)"
                  }
                },
                {
                  "column": {
                    "name": "username",
                    "type": "varchar(30)"
                  }
                },
                {
                  "column": {
                    "name": "is_main",
                    "type": "boolean"
                  }
                }
              ]
            }
          },
          {
            "createTable": {
              "tableName": "ability_notification",
              "columns": [
                {
                  "column": {
                    "name": "id",
                    "type": "bigint",
                    "autoIncrement": true,
                    "constraints": {
                      "primaryKey": true,
                      "nullable": false
                    }
                  }
                },
                {
                  "column": {
                    "name": "user_id",
                    "type": "varchar(40)",
                    "constraints": {
                      "nullable": false
                    }
                  }
                },
                {
                  "column": {
                    "name": "gear",
                    "type": "varchar(40)"
                  }
                },
                {
                  "column": {
                    "name": "main",
                    "type": "varchar(40)"
                  }
                },
                {
                  "column": {
                    "name": "favored",
                    "type": "varchar(40)"
                  }
                }
              ]
            }
          },
          {
            "createTable": {
              "tableName": "discord_account",
              "columns": [
                {
                  "column": {
                    "name": "id",
                    "type": "bigint",
                    "autoIncrement": true,
                    "constraints": {
                      "primaryKey": true,
                      "nullable": false
                    }
                  }
                },
                {
                  "column": {
                    "name": "twitch_user_id",
                    "type": "varchar(40)",
                    "constraints": {
                      "nullable": false,
                      "unique": true
                    }
                  }
                },
                {
                  "column": {
                    "name": "discord_id",
                    "type": "bigint"
                  }
                },
                {
                  "column": {
                    "name": "consent",
                    "type": "boolean"
                  }
                }
              ]
            }
          },
          {
            "addForeignKeyConstraint": {
              "baseColumnNames": "user_id",
              "baseTableName": "ability_notification",
              "constraintName": "fk_twitch_user_id",
              "onDelete": "CASCADE",
              "onUpdate": "RESTRICT",
              "referencedColumnNames": "twitch_user_id",
              "referencedTableName": "discord_account",
              "validate": true
            }
          }
        ]
      }
    },
    {
      "changeSet": {
        "id": "2",
        "author": "strohkoenig",
        "changes": [
          {
            "dropForeignKeyConstraint": {
              "baseTableName": "ability_notification",
              "constraintName": "fk_twitch_user_id"
            }
          },
          {
            "addColumn": {
              "columns": [
                {
                  "column": {
                    "name": "discord_id",
                    "position": 2,
                    "type": "bigint"
                  }
                }
              ],
              "tableName": "ability_notification"
            }
          },
          {
            "update": {
              "columns": [
                {
                  "column": {
                    "name": "discord_id",
                    "valueComputed": "(SELECT dc.id FROM DBO.discord_account dc WHERE dc.twitch_user_id = user_id)"
                  }
                }
              ],
              "tableName": "ability_notification"
            }
          },
          {
            "delete": {
              "tableName": "ability_notification",
              "where": "discord_id IS NULL"
            }
          },
          {
            "dropColumn": {
              "columnName": "user_id",
              "tableName": "ability_notification"
            }
          },
          {
            "addForeignKeyConstraint": {
              "baseColumnNames": "discord_id",
              "baseTableName": "ability_notification",
              "constraintName": "fk_discord_id",
              "onDelete": "CASCADE",
              "onUpdate": "RESTRICT",
              "referencedColumnNames": "id",
              "referencedTableName": "discord_account",
              "validate": true
            }
          },
          {
            "dropNotNullConstraint": {
              "columnDataType": "varchar(40)",
              "columnName": "twitch_user_id",
              "tableName": "discord_account"
            }
          }
        ]
      }
    },
    {
      "changeSet": {
        "id": "3",
        "author": "strohkoenig",
        "changes": [
          {
            "createTable": {
              "tableName": "splatoon_stage",
              "columns": [
                {
                  "column": {
                    "name": "id",
                    "type": "bigint",
                    "autoIncrement": true,
                    "constraints": {
                      "primaryKey": true,
                      "nullable": false
                    }
                  }
                },
                {
                  "column": {
                    "name": "splatoon_api_id",
                    "type": "varchar(10)"
                  }
                },
                {
                  "column": {
                    "name": "name",
                    "type": "varchar(50)"
                  }
                },
                {
                  "column": {
                    "name": "image",
                    "type": "varchar(80)"
                  }
                }
              ]
            }
          },
          {
            "createTable": {
              "tableName": "splatoon_rotation",
              "columns": [
                {
                  "column": {
                    "name": "id",
                    "type": "bigint",
                    "autoIncrement": true,
                    "constraints": {
                      "primaryKey": true,
                      "nullable": false
                    }
                  }
                },
                {
                  "column": {
                    "name": "splatoon_api_id",
                    "type": "bigint"
                  }
                },
                {
                  "column": {
                    "name": "start_time",
                    "type": "bigint"
                  }
                },
                {
                  "column": {
                    "name": "end_time",
                    "type": "bigint"
                  }
                },
                {
                  "column": {
                    "name": "stage_a_id",
                    "type": "bigint"
                  }
                },
                {
                  "column": {
                    "name": "stage_b_id",
                    "type": "bigint"
                  }
                },
                {
                  "column": {
                    "name": "mode",
                    "type": "varchar(30)"
                  }
                },
                {
                  "column": {
                    "name": "rule",
                    "type": "varchar(30)"
                  }
                }
              ]
            }
          },
          {
            "addForeignKeyConstraint": {
              "baseColumnNames": "stage_a_id",
              "baseTableName": "splatoon_rotation",
              "constraintName": "fk_splatoon_rotation_stage_a_id",
              "onDelete": "RESTRICT",
              "onUpdate": "RESTRICT",
              "referencedColumnNames": "id",
              "referencedTableName": "splatoon_stage",
              "validate": true
            }
          },
          {
            "addForeignKeyConstraint": {
              "baseColumnNames": "stage_b_id",
              "baseTableName": "splatoon_rotation",
              "constraintName": "fk_splatoon_rotation_stage_b_id",
              "onDelete": "RESTRICT",
              "onUpdate": "RESTRICT",
              "referencedColumnNames": "id",
              "referencedTableName": "splatoon_stage",
              "validate": true
            }
          }
        ]
      }
    },
    {
      "changeSet": {
        "id": "4",
        "author": "strohkoenig",
        "changes": [
          {
            "createTable": {
              "tableName": "splatoon_weapon",
              "columns": [
                {
                  "column": {
                    "name": "id",
                    "type": "bigint",
                    "autoIncrement": true,
                    "constraints": {
                      "primaryKey": true,
                      "nullable": false
                    }
                  }
                },
                {
                  "column": {
                    "name": "splatoon_api_id",
                    "type": "varchar(10)"
                  }
                },
                {
                  "column": {
                    "name": "name",
                    "type": "varchar(50)"
                  }
                },
                {
                  "column": {
                    "name": "image",
                    "type": "varchar(80)"
                  }
                },
                {
                  "column": {
                    "name": "sub_splatoon_api_id",
                    "type": "varchar(10)"
                  }
                },
                {
                  "column": {
                    "name": "sub_name",
                    "type": "varchar(20)"
                  }
                },
                {
                  "column": {
                    "name": "sub_image",
                    "type": "varchar(80)"
                  }
                },
                {
                  "column": {
                    "name": "special_splatoon_api_id",
                    "type": "varchar(10)"
                  }
                },
                {
                  "column": {
                    "name": "special_name",
                    "type": "varchar(40)"
                  }
                },
                {
                  "column": {
                    "name": "special_image",
                    "type": "varchar(80)"
                  }
                },
                {
                  "column": {
                    "name": "turf",
                    "type": "bigint"
                  }
                },
                {
                  "column": {
                    "name": "wins",
                    "type": "int"
                  }
                }
              ]
            }
          },
          {
            "createTable": {
              "tableName": "splatoon_monthly_result",
              "columns": [
                {
                  "column": {
                    "name": "id",
                    "type": "bigint",
                    "autoIncrement": true,
                    "constraints": {
                      "primaryKey": true,
                      "nullable": false
                    }
                  }
                },
                {
                  "column": {
                    "name": "period_year",
                    "type": "int"
                  }
                },
                {
                  "column": {
                    "name": "period_month",
                    "type": "int"
                  }
                },
                {
                  "column": {
                    "name": "start_time",
                    "type": "bigint"
                  }
                },
                {
                  "column": {
                    "name": "end_time",
                    "type": "bigint"
                  }
                },
                {
                  "column": {
                    "name": "zones_current",
                    "type": "double"
                  }
                },
                {
                  "column": {
                    "name": "zones_peak",
                    "type": "double"
                  }
                },
                {
                  "column": {
                    "name": "zones_weapon_id",
                    "type": "bigint",
                    "constraints": {
                      "nullable": true,
                      "foreignKeyName": "fk_zones_monthly_weapon_id",
                      "references": "splatoon_weapon(id)"
                    }
                  }
                },
                {
                  "column": {
                    "name": "rainmaker_current",
                    "type": "double"
                  }
                },
                {
                  "column": {
                    "name": "rainmaker_peak",
                    "type": "double"
                  }
                },
                {
                  "column": {
                    "name": "rainmaker_weapon_id",
                    "type": "bigint",
                    "constraints": {
                      "nullable": true,
                      "foreignKeyName": "fk_rainmaker_monthly_weapon_id",
                      "references": "splatoon_weapon(id)"
                    }
                  }
                },
                {
                  "column": {
                    "name": "tower_current",
                    "type": "double"
                  }
                },
                {
                  "column": {
                    "name": "tower_peak",
                    "type": "double"
                  }
                },
                {
                  "column": {
                    "name": "tower_weapon_id",
                    "type": "bigint",
                    "constraints": {
                      "nullable": true,
                      "foreignKeyName": "fk_tower_monthly_weapon_id",
                      "references": "splatoon_weapon(id)"
                    }
                  }
                },
                {
                  "column": {
                    "name": "clams_current",
                    "type": "double"
                  }
                },
                {
                  "column": {
                    "name": "clams_peak",
                    "type": "double"
                  }
                },
                {
                  "column": {
                    "name": "clams_weapon_id",
                    "type": "bigint",
                    "constraints": {
                      "nullable": true,
                      "foreignKeyName": "fk_clams_monthly_weapon_id",
                      "references": "splatoon_weapon(id)"
                    }
                  }
                }
              ]
            }
          }
        ]
      }
    }
  ]
}
